<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Annotation App</title>
    
    <!-- Material Design 3 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@material/web/all.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .load-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .pdf-viewer {
            position: relative;
            width: 100%;
            height: calc(100vh - 200px);
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .thumbnail-container {
            display: none;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 200px);
            position: relative;
        }
        
        .thumbnail {
            width: 180px;
            height: 120px;
            object-fit: cover;
            border-radius: 16px;
            cursor: crosshair;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
        }
        
        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            color: white;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .pdf-viewer, .thumbnail {
                visibility: visible;
                position: static;
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="load-section">
            <md-filled-button id="loadBtn" icon="upload">Load PDF</md-filled-button>
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
        </div>
        
        <div id="pdfContainer">
            <div id="viewer" class="pdf-viewer">
                <canvas id="pdfCanvas"></canvas>
                <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
                <div class="fullscreen-btn" id="fullscreenBtn">
                    <span class="material-icons">expand_fullscreen</span>
                </div>
            </div>
            
            <div id="thumbnailView" class="thumbnail-container">
                <img id="thumbnailImg" class="thumbnail" alt="PDF Preview">
                <canvas id="thumbnailAnnotation" class="annotation-canvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        const { useState, useEffect, useRef } = React;
        
        // Initialize Material Components
        mdCore.initialize();
        
        // Global variables
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let canvas = document.getElementById('pdfCanvas');
        let ctx = canvas.getContext('2d');
        let annotationCtx = document.getElementById('annotationCanvas').getContext('2d');
        let thumbnailCtx = document.getElementById('thumbnailAnnotation').getContext('2d');
        let isFullscreen = false;
        let annotations = {};
        let currentStroke = [];
        let isDrawing = false;
        
        // Load PDF Button Handler
        document.getElementById('loadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                loadPDF(file);
            }
        });
        
        // Load PDF Function
        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                // Enter fullscreen
                await enterFullscreen();
                
                // Render first page
                renderPage(pageNum);
                
                // Generate thumbnail
                generateThumbnail();
                
                // Save to local storage
                saveSessionState(file.name);
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('Failed to load PDF. Please try another file.');
            }
        }
        
        // Render PDF Page
        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                renderTask.promise.then(() => {
                    pageRendering = false;
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                    
                    // Draw existing annotations
                    drawAnnotations(num);
                });
            });
            
            document.getElementById('page_num').textContent = num;
        }
        
        // Queue rendering if already rendering
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        // Generate thumbnail of first page
        async function generateThumbnail() {
            const page = await pdfDoc.getPage(1);
            const viewport = page.getViewport({ scale: 0.3 });
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.height = viewport.height;
            tempCanvas.width = viewport.width;
            
            await page.render({
                canvasContext: tempCtx,
                viewport: viewport
            }).promise;
            
            document.getElementById('thumbnailImg').src = tempCanvas.toDataURL();
        }
        
        // Drawing functionality
        function setupDrawing() {
            const annotationCanvas = document.getElementById('annotationCanvas');
            
            annotationCanvas.addEventListener('pointerdown', startDrawing);
            annotationCanvas.addEventListener('pointermove', draw);
            annotationCanvas.addEventListener('pointerup', stopDrawing);
            annotationCanvas.addEventListener('pointerleave', stopDrawing);
            
            // Prevent context menu on right click
            annotationCanvas.addEventListener('contextmenu', e => e.preventDefault());
        }
        
        function startDrawing(e) {
            if (!isFullscreen) return;
            
            isDrawing = true;
            currentStroke = [];
            
            const rect = annotationCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentStroke.push({
                x, y,
                pressure: e.pressure || 0.5,
                time: Date.now()
            });
            
            annotationCtx.beginPath();
            annotationCtx.moveTo(x, y);
        }
        
        function draw(e) {
            if (!isDrawing || !isFullscreen) return;
            
            const rect = annotationCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentStroke.push({
                x, y,
                pressure: e.pressure || 0.5,
                time: Date.now()
            });
            
            const lastPoint = currentStroke[currentStroke.length - 2];
            const currentPoint = currentStroke[currentStroke.length - 1];
            
            annotationCtx.lineWidth = Math.max(currentPoint.pressure * 5, 1);
            annotationCtx.lineCap = 'round';
            annotationCtx.strokeStyle = '#FF0000'; // Red color for annotations
            
            annotationCtx.lineTo(x, y);
            annotationCtx.stroke();
        }
        
        function stopDrawing() {
            if (!isDrawing) return;
            
            isDrawing = false;
            
            if (currentStroke.length > 1) {
                if (!annotations[pageNum]) {
                    annotations[pageNum] = [];
                }
                annotations[pageNum].push([...currentStroke]);
            }
            
            currentStroke = [];
        }
        
        function drawAnnotations(pageNumber) {
            if (!annotations[pageNumber]) return;
            
            annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
            
            annotations[pageNumber].forEach(stroke => {
                if (stroke.length < 2) return;
                
                annotationCtx.beginPath();
                annotationCtx.moveTo(stroke[0].x, stroke[0].y);
                
                for (let i = 1; i < stroke.length; i++) {
                    const point = stroke[i];
                    annotationCtx.lineWidth = Math.max(point.pressure * 5, 1);
                    annotationCtx.lineCap = 'round';
                    annotationCtx.strokeStyle = '#FF0000';
                    annotationCtx.lineTo(point.x, point.y);
                    annotationCtx.stroke();
                }
            });
        }
        
        // Fullscreen management
        async function enterFullscreen() {
            try {
                await document.documentElement.requestFullscreen();
                isFullscreen = true;
                document.getElementById('viewer').style.display = 'block';
                document.getElementById('thumbnailView').style.display = 'none';
                setupDrawing();
            } catch (err) {
                console.error('Could not enter fullscreen:', err);
            }
        }
        
        function exitFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }
        
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                isFullscreen = false;
                document.getElementById('viewer').style.display = 'none';
                document.getElementById('thumbnailView').style.display = 'flex';
                saveSessionState();
            }
        });
        
        // Thumbnail interaction
        document.getElementById('thumbnailImg').addEventListener('pointerdown', async (e) => {
            if (e.pointerType === 'pen' || e.pointerType === 'touch') {
                await enterFullscreen();
                renderPage(pageNum);
                drawAnnotations(pageNum);
            }
        });
        
        // Save/Load session state
        function saveSessionState(pdfName = '') {
            const sessionData = {
                pdfName,
                currentPage: pageNum,
                annotations: annotations,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('pdfSession', JSON.stringify(sessionData));
        }
        
        function loadSessionState() {
            const saved = localStorage.getItem('pdfSession');
            if (saved) {
                const sessionData = JSON.parse(saved);
                annotations = sessionData.annotations || {};
                pageNum = sessionData.currentPage || 1;
                
                if (sessionData.pdfName) {
                    // Here you would typically re-load the PDF
                    // For demo purposes, we'll just restore annotations
                    if (isFullscreen) {
                        renderPage(pageNum);
                        drawAnnotations(pageNum);
                    }
                }
            }
        }
        
        // Initialize
        window.onload = function() {
            loadSessionState();
            
            // Setup fullscreen button
            document.getElementById('fullscreenBtn').addEventListener('click', () => {
                if (isFullscreen) {
                    exitFullscreen();
                } else {
                    enterFullscreen();
                }
            });
        };
        
        // Cleanup on unload
        window.onbeforeunload = function() {
            saveSessionState();
        };
    </script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</body>
</html>
