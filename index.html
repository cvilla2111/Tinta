<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Simple Pen Pad</title>

  <!-- Minimal PWA manifest (inline data URL) -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href='data:application/manifest+json,{
    "name":"Simple Pen Pad",
    "short_name":"Pen Pad",
    "start_url":".",
    "display":"standalone",
    "background_color":"#ffffff",
    "theme_color":"#ffffff",
    "icons":[
      {"src":"data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22%3E%3Crect width=%22192%22 height=%22192%22 fill=%22white%22/%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml"},
      {"src":"data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22%3E%3Crect width=%22512%22 height=%22512%22 fill=%22white%22/%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}
    ]
  }' />

  <style>
    :root{
      --btn-size:35px;
      --btn-radius:4px;
      --btn-border:0.75px;
      --icon-size:24px;
      --icon-stroke:0.75px;
      --safe-top:env(safe-area-inset-top, 0px);
    }
    html,body{
      margin:0;
      height:100%;
      background:#fff;
      overscroll-behavior:none;
    }
    body{position:relative}
    #pad{
      display:block;
      width:100%;
      height:100%;
      background:#fff;
      touch-action:none;        /* no panning/zooming */
      cursor:crosshair;
    }

    /* Toolbar (top-right) */
    .toolbar{
      position:fixed;
      top:calc(var(--safe-top) + 10px);
      right:10px;
      z-index:10;
      pointer-events:none;      /* let pen events reach canvas */
    }
    .btn{
      width:var(--btn-size);
      height:var(--btn-size);
      border-radius:var(--btn-radius);
      background:#fff;
      border:var(--btn-border) solid #000;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      pointer-events:auto;      /* clickable */
      touch-action:manipulation;
    }
    .btn:active{background:#f2f2f2}
    .btn svg{
      width:var(--icon-size);
      height:var(--icon-size);
      stroke:#000;
      stroke-width:var(--icon-stroke);
      stroke-linecap:round;
      stroke-linejoin:round;
      fill:none;
      vector-effect:non-scaling-stroke;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <!-- Clear button with Lucide "trash-2" icon -->
    <button id="clearBtn" class="btn" aria-label="Clear canvas" title="Clear">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6h18" />
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        <path d="M10 11v6" />
        <path d="M14 11v6" />
      </svg>
    </button>
  </div>

  <canvas id="pad"></canvas>

  <script>
    // Service worker (offline)
    if ('serviceWorker' in navigator) {
      const sw = `
        const CACHE = 'pen-pad-v1';
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(['./'])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
        });
      `;
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type:'text/javascript'})));
    }

    const canvas = document.getElementById('pad');
    const ctx = canvas.getContext('2d', { alpha:false });

    const state = { drawing:false };
    const STROKE_MIN = 1, STROKE_RANGE = 4;

    function sizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = window.innerWidth, h = window.innerHeight;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,w,h);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
    }

    function isPen(e){ return e.pointerType === 'pen'; }
    function pressure(e){ return e.pressure > 0 ? e.pressure : 1; }
    function xy(e){
      const r = canvas.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    canvas.addEventListener('pointerdown', (e) => {
      if (!isPen(e) || e.button !== 0) { e.preventDefault(); return; }
      canvas.setPointerCapture(e.pointerId);
      state.drawing = true;
      const { x, y } = xy(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
      e.preventDefault();
    }, { passive:false });

    canvas.addEventListener('pointermove', (e) => {
      if (!state.drawing || !isPen(e)) return;
      const { x, y } = xy(e);
      ctx.lineWidth = STROKE_MIN + pressure(e) * STROKE_RANGE;
      ctx.lineTo(x, y);
      ctx.stroke();
      e.preventDefault();
    }, { passive:false });

    function endDraw(e){
      if (!state.drawing) return;
      state.drawing = false;
      try { canvas.releasePointerCapture(e.pointerId); } catch {}
      e.preventDefault();
    }
    canvas.addEventListener('pointerup', endDraw, { passive:false });
    canvas.addEventListener('pointercancel', endDraw, { passive:false });
    canvas.addEventListener('pointerout', endDraw, { passive:false });

    // Block finger/mouse drawing
    canvas.addEventListener('pointerdown', (e) => {
      if (!isPen(e)) e.preventDefault();
    }, { passive:false });
    canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive:false });
    canvas.addEventListener('touchmove', (e) => e.preventDefault(), { passive:false });
    canvas.addEventListener('touchend', (e) => e.preventDefault(), { passive:false });

    // Clear
    document.getElementById('clearBtn').addEventListener('click', () => {
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = window.innerWidth, h = window.innerHeight;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,w,h);
    });

    sizeCanvas();
    window.addEventListener('resize', sizeCanvas);
  </script>
</body>
</html>
