<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Drawing Canvas2</title>
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* ===== CANVAS ===== */
        #canvas {
            display: block;
            background: white;
            cursor: crosshair;
        }
        
        #error {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            position: fixed;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            z-index: 999;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        #menuBtn {
            top: 20px;
            left: 20px;
            background: #5D5CDE;
            color: white;
        }
        
        #menuBtn:hover {
            background: #4a49c7;
        }
        
        #clearBtn {
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
        }
        
        #clearBtn:hover {
            background: #c82333;
        }
        
        /* ===== SETTINGS DRAWER ===== */
        .drawer {
            position: fixed;
            left: -320px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
        }
        
        .drawer.open {
            left: 0;
        }
        
        .drawer-header {
            padding: 20px;
            background: #5D5CDE;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drawer-header h3 {
            font-size: 18px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .drawer-content {
            padding: 20px;
        }
        
        /* ===== CONTROLS ===== */
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        /* Range Sliders */
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 8px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
            border: none;
        }
        
        /* Value Display */
        .control-group span {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #6c757d;
            min-width: 40px;
            text-align: center;
        }
        
        /* ===== TOGGLE SWITCH ===== */
        .toggle-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px !important;
        }
        
        .toggle-label input[type="checkbox"] {
            display: none;
        }
        
        .toggle-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            margin-right: 12px;
            transition: background 0.3s;
        }
        
        .toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: #5D5CDE;
        }
        
        .toggle-label input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        #pressureControls {
            transition: opacity 0.3s;
        }
        
        #pressureControls.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Main Canvas -->
    <canvas id="canvas"></canvas>
    
    <!-- Error Message -->
    <div id="error">Ink API not supported in this browser</div>
    
    <!-- Control Buttons -->
    <button id="menuBtn" class="btn">‚ò∞</button>
    <button id="clearBtn" class="btn">üóëÔ∏è</button>
    
    <!-- Settings Drawer -->
    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <h3>Pen Settings</h3>
            <button id="closeDrawer" class="close-btn">&times;</button>
        </div>
        <div class="drawer-content">
            <div class="control-group">
                <label for="minStroke">Min Stroke Size</label>
                <input type="range" id="minStroke" min="0.5" max="5" step="0.5" value="0.5">
                <span id="minValue">0.5px</span>
            </div>
            
            <div class="control-group">
                <label for="maxStroke">Max Stroke Size</label>
                <input type="range" id="maxStroke" min="3" max="20" step="1" value="10">
                <span id="maxValue">10px</span>
            </div>
            
            <div class="control-group">
                <label class="toggle-label">
                    <input type="checkbox" id="pressureToggle" checked>
                    <span class="toggle-slider"></span>
                    Pressure Sensitivity
                </label>
            </div>
            
            <div class="control-group" id="pressureControls">
                <label for="pressureSensitivity">Sensitivity Level</label>
                <input type="range" id="pressureSensitivity" min="0.1" max="2" step="0.1" value="0.4">
                <span id="sensitivityValue">0.4x</span>
            </div>
            
            <div class="control-group">
                <label for="smoothing">Stroke Smoothing</label>
                <input type="range" id="smoothing" min="0" max="1" step="0.1" value="0.2">
                <span id="smoothingValue">0.2</span>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const errorDiv = document.getElementById('error');
        
        // Ink API
        let presenter = null;
        
        // Drawing state
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let prevX = 0, prevY = 0;
        
        // Stroke settings (defaults match HTML values)
        let minStrokeSize = 0.5;
        let maxStrokeSize = 10;
        let pressureSensitivity = 0.4;
        let pressureEnabled = true;
        let smoothingFactor = 0.2;
        
        // ===== CANVAS SETUP =====
        function setupCanvas() {
            canvas.style.width = '100vw';
            canvas.style.height = '100vh';
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.scale(dpr, dpr);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
        }
        
        // ===== INK API INITIALIZATION =====
        async function initInkAPI() {
            if (!navigator.ink) {
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                presenter = await navigator.ink.requestPresenter({ presentationArea: canvas });
                console.log('Ink API ready');
            } catch (err) {
                console.error('Ink API failed:', err);
                errorDiv.textContent = 'Ink API failed to initialize';
                errorDiv.style.display = 'block';
            }
        }
        
        // ===== DRAWING FUNCTIONS =====
        function calculateLineWidth(pressure) {
            if (!pressureEnabled) {
                return (minStrokeSize + maxStrokeSize) / 2;
            }
            
            const minPressureThreshold = 0.02;
            
            if (pressure <= minPressureThreshold) {
                return minStrokeSize;
            }
            
            const normalizedPressure = Math.min(1, (pressure - minPressureThreshold) / (1 - minPressureThreshold));
            const adjustedPressure = Math.pow(normalizedPressure, 1 / pressureSensitivity);
            
            return minStrokeSize + (maxStrokeSize - minStrokeSize) * adjustedPressure;
        }
        
        function startDrawing(x, y, pressure = 0.5) {
            isDrawing = true;
            lastX = x;
            lastY = y;
            prevX = x;
            prevY = y;
            
            ctx.strokeStyle = 'black';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        
        function draw(x, y, pressure = 0.5) {
            if (!isDrawing) return;
            
            const lineWidth = calculateLineWidth(pressure);
            ctx.lineWidth = lineWidth;
            
            if (smoothingFactor === 0) {
                // No smoothing - straight lines
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            } else {
                // Quadratic curve smoothing
                const midX = (lastX + x) / 2;
                const midY = (lastY + y) / 2;
                
                ctx.beginPath();
                if (prevX === lastX && prevY === lastY) {
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(midX, midY);
                } else {
                    ctx.moveTo(prevX, prevY);
                    ctx.quadraticCurveTo(lastX, lastY, midX, midY);
                }
                ctx.stroke();
                
                prevX = midX;
                prevY = midY;
                lastX = x;
                lastY = y;
            }
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function updateInkAPI(evt, pressure) {
            if (!presenter) return;
            
            const lineWidth = calculateLineWidth(pressure);
            const inkDiameter = Math.max(1, lineWidth - 1);
            
            try {
                presenter.updateInkTrailStartPoint(evt, {
                    color: 'black',
                    diameter: inkDiameter
                });
            } catch (err) {
                console.error('Ink API update failed:', err);
            }
        }
        
        // ===== EVENT HANDLERS =====
        function setupEventListeners() {
            // Pointer events (stylus/pen)
            canvas.addEventListener('pointerdown', (evt) => {
                evt.preventDefault();
                if (evt.pointerType === 'touch') return;
                
                const pressure = evt.pressure || 0.5;
                startDrawing(evt.offsetX, evt.offsetY, pressure);
                updateInkAPI(evt, pressure);
            });
            
            canvas.addEventListener('pointermove', (evt) => {
                evt.preventDefault();
                if (evt.pointerType === 'touch') return;
                
                const pressure = evt.pressure || 0.5;
                draw(evt.offsetX, evt.offsetY, pressure);
                if (isDrawing) updateInkAPI(evt, pressure);
            });
            
            canvas.addEventListener('pointerup', (evt) => {
                evt.preventDefault();
                if (evt.pointerType === 'touch') return;
                stopDrawing();
            });
            
            canvas.addEventListener('pointerleave', (evt) => {
                evt.preventDefault();
                if (evt.pointerType === 'touch') return;
                stopDrawing();
            });
            
            // Mouse events (fallback)
            canvas.addEventListener('mousedown', (evt) => {
                evt.preventDefault();
                startDrawing(evt.offsetX, evt.offsetY);
            });
            
            canvas.addEventListener('mousemove', (evt) => {
                evt.preventDefault();
                draw(evt.offsetX, evt.offsetY);
            });
            
            canvas.addEventListener('mouseup', (evt) => {
                evt.preventDefault();
                stopDrawing();
            });
            
            canvas.addEventListener('mouseleave', (evt) => {
                evt.preventDefault();
                stopDrawing();
            });
            
            // Disable touch events
            ['touchstart', 'touchmove', 'touchend'].forEach(event => {
                canvas.addEventListener(event, (evt) => evt.preventDefault());
            });
            
            // Clear canvas on double click
            canvas.addEventListener('dblclick', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            // Close drawer when clicking canvas
            canvas.addEventListener('pointerdown', () => {
                document.getElementById('drawer').classList.remove('open');
            });
        }
        
        // ===== UI CONTROLS =====
        function setupUI() {
            const drawer = document.getElementById('drawer');
            const menuBtn = document.getElementById('menuBtn');
            const closeBtn = document.getElementById('closeDrawer');
            const clearBtn = document.getElementById('clearBtn');
            
            // Drawer toggle
            menuBtn.addEventListener('click', () => drawer.classList.add('open'));
            closeBtn.addEventListener('click', () => drawer.classList.remove('open'));
            
            // Clear button
            clearBtn.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            // Controls
            setupControls();
        }
        
        function setupControls() {
            const minStrokeSlider = document.getElementById('minStroke');
            const maxStrokeSlider = document.getElementById('maxStroke');
            const pressureSensitivitySlider = document.getElementById('pressureSensitivity');
            const pressureToggle = document.getElementById('pressureToggle');
            const pressureControls = document.getElementById('pressureControls');
            const smoothingSlider = document.getElementById('smoothing');
            
            const minValueDisplay = document.getElementById('minValue');
            const maxValueDisplay = document.getElementById('maxValue');
            const sensitivityValueDisplay = document.getElementById('sensitivityValue');
            const smoothingValueDisplay = document.getElementById('smoothingValue');
            
            // Min stroke size
            minStrokeSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                minStrokeSize = value;
                minValueDisplay.textContent = value + 'px';
                
                if (value >= maxStrokeSize) {
                    maxStrokeSize = value + 1;
                    maxStrokeSlider.value = maxStrokeSize;
                    maxValueDisplay.textContent = maxStrokeSize + 'px';
                }
            });
            
            // Max stroke size
            maxStrokeSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                maxStrokeSize = value;
                maxValueDisplay.textContent = value + 'px';
                
                if (value <= minStrokeSize) {
                    minStrokeSize = Math.max(0.5, value - 1);
                    minStrokeSlider.value = minStrokeSize;
                    minValueDisplay.textContent = minStrokeSize + 'px';
                }
            });
            
            // Pressure sensitivity
            pressureSensitivitySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                pressureSensitivity = value;
                sensitivityValueDisplay.textContent = value.toFixed(1) + 'x';
            });
            
            // Pressure toggle
            pressureToggle.addEventListener('change', (e) => {
                pressureEnabled = e.target.checked;
                pressureControls.classList.toggle('disabled', !pressureEnabled);
            });
            
            // Smoothing
            smoothingSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                smoothingFactor = value;
                smoothingValueDisplay.textContent = value.toFixed(1);
            });
        }
        
        // ===== INITIALIZATION =====
        function init() {
            setupCanvas();
            setupEventListeners();
            setupUI();
            initInkAPI();
        }
        
        // Start the application
        init();
    </script>
</body>
</html>
