<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Annotator - Professional Stylus Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
            color: #3498db;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        main {
            display: flex;
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        
        .sidebar {
            width: 260px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 1.5rem;
            height: fit-content;
        }
        
        .sidebar h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .tool-section {
            margin-bottom: 1.5rem;
        }
        
        .tool-section h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #7f8c8d;
            margin-bottom: 0.8rem;
        }
        
        .tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .tool-btn {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tool-btn:hover {
            background-color: #e9f7fe;
            border-color: #3498db;
        }
        
        .tool-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .tool-btn i {
            font-size: 1.2rem;
        }
        
        .tool-btn span {
            font-size: 0.75rem;
        }
        
        .tool-btn.stylus-tool {
            border: 2px solid #9b59b6;
        }
        
        .tool-btn.stylus-tool.active {
            background-color: #9b59b6;
            border-color: #9b59b6;
        }
        
        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.active {
            border-color: #2c3e50;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #2c3e50;
        }
        
        .pdf-container {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pdf-toolbar {
            background-color: #f8f9fa;
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        .pdf-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s ease;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-stylus {
            background-color: #9b59b6;
        }
        
        .btn-stylus:hover {
            background-color: #8e44ad;
        }
        
        .pdf-viewer {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            background-color: #e9ecef;
            position: relative;
        }
        
        .pdf-page {
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            position: relative;
            width: 100%;
            max-width: 800px;
            touch-action: none;
        }
        
        .pdf-page canvas {
            display: block;
            width: 100%;
            height: auto;
        }
        
        .annotation-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .annotation {
            position: absolute;
            pointer-events: auto;
        }
        
        .text-annotation {
            background-color: rgba(255, 255, 0, 0.3);
            border: 1px dashed #f1c40f;
            padding: 5px;
            min-width: 100px;
            min-height: 30px;
            cursor: move;
        }
        
        .text-annotation textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        
        .highlight-annotation {
            background-color: rgba(255, 255, 0, 0.4);
            cursor: pointer;
        }
        
        .drawing-annotation {
            cursor: pointer;
        }
        
        .drawing-annotation svg {
            width: 100%;
            height: 100%;
        }
        
        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 3rem;
            text-align: center;
            background-color: #f8f9fa;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            color: #7f8c8d;
        }
        
        .upload-area i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }
        
        .upload-area h3 {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .upload-area p {
            margin-bottom: 1.5rem;
            max-width: 400px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.7rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .page-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-info {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .nav-btn {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .nav-btn:hover {
            background-color: #f8f9fa;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .zoom-btn {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .zoom-btn:hover {
            background-color: #f8f9fa;
        }
        
        .zoom-level {
            font-size: 0.9rem;
            color: #7f8c8d;
            min-width: 45px;
            text-align: center;
        }
        
        .annotation-popup {
            position: absolute;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 100;
            display: none;
        }
        
        .annotation-popup button {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
            text-align: left;
        }
        
        .annotation-popup button:hover {
            background-color: #f8f9fa;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast i {
            font-size: 1.2rem;
        }
        
        .stylus-settings {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .setting-item {
            margin-bottom: 0.8rem;
        }
        
        .setting-item label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
            color: #555;
        }
        
        .setting-item input[type="range"] {
            width: 100%;
        }
        
        .setting-value {
            display: inline-block;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-left: 5px;
        }
        
        .pressure-indicator {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .pressure-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #9b59b6);
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .tilt-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        
        .tilt-value {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .ink-preview {
            margin-top: 1rem;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .ink-preview-canvas {
            width: 100%;
            height: 60px;
            background-color: white;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .stylus-status {
            margin-top: 1rem;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pen {
            background-color: #9b59b6;
        }
        
        .status-eraser {
            background-color: #e74c3c;
        }
        
        @media (max-width: 1024px) {
            main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .pdf-container {
                order: 1;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tools {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pdf-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-file-pdf"></i>
                <h1>PDF Annotator - Professional Stylus Edition</h1>
            </div>
            <div class="user-info">
                <span>Welcome, User</span>
                <div class="user-avatar">U</div>
            </div>
        </div>
    </header>
    
    <main>
        <aside class="sidebar">
            <h2>Annotation Tools</h2>
            
            <div class="tool-section">
                <h3>Tools</h3>
                <div class="tools">
                    <div class="tool-btn" data-tool="select">
                        <i class="fas fa-mouse-pointer"></i>
                        <span>Select</span>
                    </div>
                    <div class="tool-btn" data-tool="text">
                        <i class="fas fa-font"></i>
                        <span>Text</span>
                    </div>
                    <div class="tool-btn" data-tool="highlight">
                        <i class="fas fa-highlighter"></i>
                        <span>Highlight</span>
                    </div>
                    <div class="tool-btn stylus-tool active" data-tool="pen">
                        <i class="fas fa-pen"></i>
                        <span>Pen</span>
                    </div>
                    <div class="tool-btn" data-tool="eraser">
                        <i class="fas fa-eraser"></i>
                        <span>Eraser</span>
                    </div>
                    <div class="tool-btn" data-tool="rectangle">
                        <i class="fas fa-square"></i>
                        <span>Rectangle</span>
                    </div>
                    <div class="tool-btn" data-tool="circle">
                        <i class="fas fa-circle"></i>
                        <span>Circle</span>
                    </div>
                    <div class="tool-btn" data-tool="line">
                        <i class="fas fa-minus"></i>
                        <span>Line</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3>Colors</h3>
                <div class="color-picker">
                    <div class="color-option active" style="background-color: #f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-option" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-option" style="background-color: #3498db;" data-color="#3498db"></div>
                    <div class="color-option" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-option" style="background-color: #9b59b6;" data-color="#9b59b6"></div>
                    <div class="color-option" style="background-color: #34495e;" data-color="#34495e"></div>
                </div>
            </div>
            
            <div class="tool-section stylus-settings">
                <h3>Stylus Settings</h3>
                
                <div class="setting-item">
                    <label>Pressure Sensitivity: <span class="setting-value" id="pressure-value">75%</span></label>
                    <input type="range" id="pressure-sensitivity" min="0" max="100" value="75">
                    <div class="pressure-indicator">
                        <div class="pressure-bar" id="pressure-bar"></div>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>Tilt Sensitivity: <span class="setting-value" id="tilt-value">50%</span></label>
                    <input type="range" id="tilt-sensitivity" min="0" max="100" value="50">
                    <div class="tilt-indicator">
                        <span class="tilt-value">X: <span id="tilt-x">0</span>°</span>
                        <span class="tilt-value">Y: <span id="tilt-y">0</span>°</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>Min Line Width: <span class="setting-value" id="min-width-value">0.1px</span></label>
                    <input type="range" id="min-line-width" min="0.1" max="5" step="0.1" value="0.1">
                </div>
                
                <div class="setting-item">
                    <label>Max Line Width: <span class="setting-value" id="max-width-value">12px</span></label>
                    <input type="range" id="max-line-width" min="5" max="30" value="12">
                </div>
                
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="opacity-pressure" checked> Pressure Opacity
                    </label>
                </div>
                
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="palm-rejection" checked> Palm Rejection
                    </label>
                </div>
                
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="button-eraser" checked> Button = Eraser
                    </label>
                </div>
                
                <div class="ink-preview">
                    <label>Ink Preview</label>
                    <canvas class="ink-preview-canvas" id="ink-preview"></canvas>
                </div>
                
                <div class="stylus-status">
                    <label>Stylus Mode:</label>
                    <div>
                        <span class="status-indicator status-pen" id="status-indicator"></span>
                        <span id="status-text">Pen</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3>Actions</h3>
                <button class="btn" id="clear-annotations">
                    <i class="fas fa-eraser"></i> Clear All
                </button>
            </div>
        </aside>
        
        <section class="pdf-container">
            <div class="pdf-toolbar">
                <div class="pdf-actions">
                    <button class="btn" id="upload-btn">
                        <i class="fas fa-upload"></i> Upload PDF
                    </button>
                    <input type="file" id="file-input" class="file-input" accept=".pdf">
                    <button class="btn btn-stylus" id="calibrate-stylus">
                        <i class="fas fa-sliders-h"></i> Calibrate Stylus
                    </button>
                    <button class="btn btn-secondary" id="save-btn" disabled>
                        <i class="fas fa-save"></i> Save Annotated
                    </button>
                </div>
                
                <div class="page-navigation">
                    <button class="nav-btn" id="prev-page" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="page-info">Page <span id="page-num">0</span> of <span id="page-count">0</span></span>
                    <button class="nav-btn" id="next-page" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="zoom-btn" id="zoom-in">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="pdf-viewer" id="pdf-viewer">
                <div class="upload-area" id="upload-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Upload a PDF Document</h3>
                    <p>Drag and drop a PDF file here or click the button below to browse</p>
                    <button class="upload-btn" id="upload-area-btn">Select PDF File</button>
                </div>
            </div>
        </section>
    </main>
    
    <div class="annotation-popup" id="annotation-popup">
        <button id="delete-annotation">
            <i class="fas fa-trash"></i> Delete Annotation
        </button>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Action completed successfully</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // Set the worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Application state
        const app = {
            pdfDoc: null,
            pageNum: 1,
            pageRendering: false,
            pageNumPending: null,
            scale: 1.2,
            canvas: null,
            ctx: null,
            currentTool: 'pen',
            previousTool: 'pen',
            currentColor: '#f1c40f',
            annotations: [],
            isDrawing: false,
            startX: 0,
            startY: 0,
            currentAnnotation: null,
            selectedAnnotation: null,
            stylusSettings: {
                pressureSensitivity: 0.75,
                tiltSensitivity: 0.5,
                minLineWidth: 0.1,
                maxLineWidth: 12,
                opacityPressure: true,
                palmRejection: true,
                buttonEraser: true
            },
            currentPressure: 0,
            currentTiltX: 0,
            currentTiltY: 0,
            lastPoint: null,
            inkPreviewCtx: null,
            isStylusButtonPressed: false
        };

        // DOM elements
        const elements = {
            uploadBtn: document.getElementById('upload-btn'),
            fileInput: document.getElementById('file-input'),
            uploadArea: document.getElementById('upload-area'),
            uploadAreaBtn: document.getElementById('upload-area-btn'),
            saveBtn: document.getElementById('save-btn'),
            pdfViewer: document.getElementById('pdf-viewer'),
            pageNum: document.getElementById('page-num'),
            pageCount: document.getElementById('page-count'),
            prevPageBtn: document.getElementById('prev-page'),
            nextPageBtn: document.getElementById('next-page'),
            zoomInBtn: document.getElementById('zoom-in'),
            zoomOutBtn: document.getElementById('zoom-out'),
            zoomLevel: document.getElementById('zoom-level'),
            clearAnnotationsBtn: document.getElementById('clear-annotations'),
            toolBtns: document.querySelectorAll('.tool-btn'),
            colorOptions: document.querySelectorAll('.color-option'),
            annotationPopup: document.getElementById('annotation-popup'),
            deleteAnnotationBtn: document.getElementById('delete-annotation'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            pressureSensitivity: document.getElementById('pressure-sensitivity'),
            pressureValue: document.getElementById('pressure-value'),
            pressureBar: document.getElementById('pressure-bar'),
            tiltSensitivity: document.getElementById('tilt-sensitivity'),
            tiltValue: document.getElementById('tilt-value'),
            tiltX: document.getElementById('tilt-x'),
            tiltY: document.getElementById('tilt-y'),
            minLineWidth: document.getElementById('min-line-width'),
            minWidthValue: document.getElementById('min-width-value'),
            maxLineWidth: document.getElementById('max-line-width'),
            maxWidthValue: document.getElementById('max-width-value'),
            opacityPressure: document.getElementById('opacity-pressure'),
            palmRejection: document.getElementById('palm-rejection'),
            buttonEraser: document.getElementById('button-eraser'),
            calibrateStylus: document.getElementById('calibrate-stylus'),
            inkPreview: document.getElementById('ink-preview'),
            statusIndicator: document.getElementById('status-indicator'),
            statusText: document.getElementById('status-text')
        };

        // Initialize event listeners
        function initEventListeners() {
            elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
            elements.uploadAreaBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            
            elements.prevPageBtn.addEventListener('click', () => {
                if (app.pageNum <= 1) return;
                app.pageNum--;
                queueRenderPage(app.pageNum);
            });
            
            elements.nextPageBtn.addEventListener('click', () => {
                if (app.pageNum >= app.pdfDoc.numPages) return;
                app.pageNum++;
                queueRenderPage(app.pageNum);
            });
            
            elements.zoomInBtn.addEventListener('click', () => {
                app.scale += 0.2;
                renderPage(app.pageNum);
                updateZoomLevel();
            });
            
            elements.zoomOutBtn.addEventListener('click', () => {
                if (app.scale <= 0.4) return;
                app.scale -= 0.2;
                renderPage(app.pageNum);
                updateZoomLevel();
            });
            
            elements.clearAnnotationsBtn.addEventListener('click', clearAllAnnotations);
            elements.saveBtn.addEventListener('click', saveAnnotatedPDF);
            elements.calibrateStylus.addEventListener('click', calibrateStylus);
            
            elements.toolBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.toolBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    app.currentTool = btn.dataset.tool;
                    app.previousTool = app.currentTool;
                    updateStylusStatus();
                });
            });
            
            elements.colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.colorOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    app.currentColor = option.dataset.color;
                    updateInkPreview();
                });
            });
            
            elements.deleteAnnotationBtn.addEventListener('click', deleteSelectedAnnotation);
            
            // Stylus settings
            elements.pressureSensitivity.addEventListener('input', (e) => {
                app.stylusSettings.pressureSensitivity = e.target.value / 100;
                elements.pressureValue.textContent = e.target.value + '%';
                updateInkPreview();
            });
            
            elements.tiltSensitivity.addEventListener('input', (e) => {
                app.stylusSettings.tiltSensitivity = e.target.value / 100;
                elements.tiltValue.textContent = e.target.value + '%';
            });
            
            elements.minLineWidth.addEventListener('input', (e) => {
                app.stylusSettings.minLineWidth = parseFloat(e.target.value);
                elements.minWidthValue.textContent = e.target.value + 'px';
                updateInkPreview();
            });
            
            elements.maxLineWidth.addEventListener('input', (e) => {
                app.stylusSettings.maxLineWidth = parseInt(e.target.value);
                elements.maxWidthValue.textContent = e.target.value + 'px';
                updateInkPreview();
            });
            
            elements.opacityPressure.addEventListener('change', (e) => {
                app.stylusSettings.opacityPressure = e.target.checked;
                updateInkPreview();
            });
            
            elements.palmRejection.addEventListener('change', (e) => {
                app.stylusSettings.palmRejection = e.target.checked;
            });
            
            elements.buttonEraser.addEventListener('change', (e) => {
                app.stylusSettings.buttonEraser = e.target.checked;
                if (e.target.checked) {
                    showToast('Stylus button will now activate eraser');
                } else {
                    showToast('Stylus button eraser disabled');
                }
            });
            
            // Hide popup when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.annotationPopup.contains(e.target)) {
                    elements.annotationPopup.style.display = 'none';
                }
            });
        }

        // Initialize ink preview
        function initInkPreview() {
            const canvas = elements.inkPreview;
            app.inkPreviewCtx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            app.inkPreviewCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            updateInkPreview();
        }

        // Update ink preview
        function updateInkPreview() {
            const ctx = app.inkPreviewCtx;
            const canvas = elements.inkPreview;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sample strokes with varying pressure
            const centerY = canvas.height / (2 * window.devicePixelRatio);
            const startX = 10;
            const endX = canvas.width / window.devicePixelRatio - 10;
            
            // Draw pressure gradient stroke
            ctx.beginPath();
            ctx.moveTo(startX, centerY);
            
            for (let x = startX; x <= endX; x += 2) {
                const pressure = (x - startX) / (endX - startX);
                const lineWidth = calculateLineWidth(pressure);
                const opacity = app.stylusSettings.opacityPressure ? 0.3 + (pressure * 0.7) : 1;
                
                ctx.lineWidth = lineWidth;
                ctx.globalAlpha = opacity;
                ctx.strokeStyle = app.currentColor;
                ctx.lineTo(x, centerY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, centerY);
            }
            
            // Reset global alpha
            ctx.globalAlpha = 1;
        }

        // Calculate line width based on pressure
        function calculateLineWidth(pressure) {
            const min = app.stylusSettings.minLineWidth;
            const max = app.stylusSettings.maxLineWidth;
            const sensitivity = app.stylusSettings.pressureSensitivity;
            
            // Apply sensitivity curve (more pronounced at higher sensitivities)
            const adjustedPressure = Math.pow(pressure, 1.5 - sensitivity);
            
            return min + (max - min) * adjustedPressure;
        }

        // Update stylus status indicator
        function updateStylusStatus() {
            if (app.currentTool === 'eraser') {
                elements.statusIndicator.className = 'status-indicator status-eraser';
                elements.statusText.textContent = 'Eraser';
            } else {
                elements.statusIndicator.className = 'status-indicator status-pen';
                elements.statusText.textContent = 'Pen';
            }
        }

        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file.type !== 'application/pdf') {
                showToast('Please select a PDF file', 'error');
                return;
            }
            
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                loadPDF(typedarray);
            };
            fileReader.readAsArrayBuffer(file);
        }

        // Load PDF document
        function loadPDF(data) {
            pdfjsLib.getDocument(data).promise.then(function(pdf) {
                app.pdfDoc = pdf;
                elements.pageCount.textContent = pdf.numPages;
                elements.pageNum.textContent = app.pageNum;
                
                // Enable navigation buttons
                elements.prevPageBtn.disabled = false;
                elements.nextPageBtn.disabled = false;
                elements.saveBtn.disabled = false;
                
                // Render the first page
                renderPage(app.pageNum);
                
                // Hide upload area
                elements.uploadArea.style.display = 'none';
                
                showToast('PDF loaded successfully');
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                showToast('Error loading PDF', 'error');
            });
        }

        // Render page
        function renderPage(num) {
            app.pageRendering = true;
            
            // Clear previous annotations
            app.annotations = app.annotations.filter(ann => ann.page !== num);
            
            app.pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: app.scale });
                
                // Prepare canvas using PDF page dimensions
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    app.pageRendering = false;
                    
                    // Clear previous page content
                    elements.pdfViewer.innerHTML = '';
                    
                    // Create page container
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page';
                    pageContainer.dataset.pageNum = num;
                    
                    // Add canvas to page container
                    pageContainer.appendChild(canvas);
                    
                    // Create annotation layer
                    const annotationLayer = document.createElement('div');
                    annotationLayer.className = 'annotation-layer';
                    pageContainer.appendChild(annotationLayer);
                    
                    // Add page container to viewer
                    elements.pdfViewer.appendChild(pageContainer);
                    
                    // Set up annotation events
                    setupAnnotationEvents(pageContainer, annotationLayer);
                    
                    // Re-render annotations for this page
                    renderAnnotationsForPage(num, annotationLayer);
                    
                    if (app.pageNumPending !== null) {
                        renderPage(app.pageNumPending);
                        app.pageNumPending = null;
                    }
                });
            });
            
            // Update page counter
            elements.pageNum.textContent = num;
        }

        // Queue render page
        function queueRenderPage(num) {
            if (app.pageRendering) {
                app.pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        // Update zoom level display
        function updateZoomLevel() {
            elements.zoomLevel.textContent = Math.round(app.scale * 100) + '%';
        }

        // Set up annotation events
        function setupAnnotationEvents(pageContainer, annotationLayer) {
            // Pointer events for stylus support
            pageContainer.addEventListener('pointerdown', startAnnotation);
            pageContainer.addEventListener('pointermove', continueAnnotation);
            pageContainer.addEventListener('pointerup', endAnnotation);
            pageContainer.addEventListener('pointercancel', endAnnotation);
            
            // Prevent default touch actions to enable stylus
            pageContainer.addEventListener('touchstart', (e) => e.preventDefault());
            pageContainer.addEventListener('touchmove', (e) => e.preventDefault());
        }

        // Start annotation
        function startAnnotation(e) {
            // Check for stylus button press
            if (e.pointerType === 'pen' && app.stylusSettings.buttonEraser) {
                // Check if any button is pressed (buttons property is a bitmask)
                // 1 = primary button (pen tip), 2 = secondary button (barrel button)
                if (e.buttons === 2) {
                    // Stylus button is pressed - switch to eraser
                    if (app.currentTool !== 'eraser') {
                        app.previousTool = app.currentTool;
                        app.currentTool = 'eraser';
                        app.isStylusButtonPressed = true;
                        updateStylusStatus();
                        updateToolButtonSelection();
                    }
                }
            }
            
            // Check if it's a stylus event and apply palm rejection
            if (e.pointerType === 'pen' && app.stylusSettings.palmRejection) {
                // Enhanced palm rejection: ignore if pressure is too low
                if (e.pressure < 0.05) return;
            }
            
            if (app.currentTool === 'select') return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            app.startX = e.clientX - rect.left;
            app.startY = e.clientY - rect.top;
            app.isDrawing = true;
            
            // Update stylus indicators
            if (e.pointerType === 'pen') {
                app.currentPressure = e.pressure;
                app.currentTiltX = e.tiltX;
                app.currentTiltY = e.tiltY;
                updateStylusIndicators();
            }
            
            // Store the last point for smooth drawing
            app.lastPoint = {
                x: app.startX,
                y: app.startY,
                pressure: e.pressure || 0.5
            };
            
            // Create temporary annotation
            if (app.currentTool === 'text') {
                createTextAnnotation(app.startX, app.startY);
            } else if (app.currentTool === 'highlight') {
                app.currentAnnotation = {
                    type: 'highlight',
                    x: app.startX,
                    y: app.startY,
                    width: 0,
                    height: 20,
                    color: app.currentColor,
                    page: app.pageNum
                };
            } else if (app.currentTool === 'pen') {
                app.currentAnnotation = {
                    type: 'draw',
                    points: [{
                        x: app.startX, 
                        y: app.startY, 
                        pressure: e.pressure || 0.5,
                        tiltX: e.tiltX || 0,
                        tiltY: e.tiltY || 0
                    }],
                    color: app.currentColor,
                    page: app.pageNum,
                    tool: app.currentTool
                };
            } else if (app.currentTool === 'eraser') {
                // Eraser tool - find and remove annotations at this position
                eraseAnnotation(app.startX, app.startY);
            } else if (app.currentTool === 'rectangle') {
                app.currentAnnotation = {
                    type: 'rectangle',
                    x: app.startX,
                    y: app.startY,
                    width: 0,
                    height: 0,
                    color: app.currentColor,
                    page: app.pageNum
                };
            } else if (app.currentTool === 'circle') {
                app.currentAnnotation = {
                    type: 'circle',
                    x: app.startX,
                    y: app.startY,
                    radius: 0,
                    color: app.currentColor,
                    page: app.pageNum
                };
            } else if (app.currentTool === 'line') {
                app.currentAnnotation = {
                    type: 'line',
                    x1: app.startX,
                    y1: app.startY,
                    x2: app.startX,
                    y2: app.startY,
                    color: app.currentColor,
                    page: app.pageNum
                };
            }
        }

        // Continue annotation
        function continueAnnotation(e) {
            if (!app.isDrawing || app.currentTool === 'text') return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // Update stylus indicators
            if (e.pointerType === 'pen') {
                app.currentPressure = e.pressure;
                app.currentTiltX = e.tiltX;
                app.currentTiltY = e.tiltY;
                updateStylusIndicators();
            }
            
            if (app.currentTool === 'highlight') {
                app.currentAnnotation.width = currentX - app.startX;
                app.currentAnnotation.height = 20;
            } else if (app.currentTool === 'pen') {
                const pressure = e.pressure || 0.5;
                const tiltX = e.tiltX || 0;
                const tiltY = e.tiltY || 0;
                
                // Add interpolated points for smoother drawing
                if (app.lastPoint) {
                    const distance = Math.sqrt(
                        Math.pow(currentX - app.lastPoint.x, 2) + 
                        Math.pow(currentY - app.lastPoint.y, 2)
                    );
                    
                    // Add intermediate points if distance is large
                    if (distance > 5) {
                        const steps = Math.ceil(distance / 2);
                        for (let i = 1; i <= steps; i++) {
                            const t = i / steps;
                            const interpolatedX = app.lastPoint.x + (currentX - app.lastPoint.x) * t;
                            const interpolatedY = app.lastPoint.y + (currentY - app.lastPoint.y) * t;
                            const interpolatedPressure = app.lastPoint.pressure + (pressure - app.lastPoint.pressure) * t;
                            
                            app.currentAnnotation.points.push({
                                x: interpolatedX,
                                y: interpolatedY,
                                pressure: interpolatedPressure,
                                tiltX: tiltX,
                                tiltY: tiltY
                            });
                        }
                    } else {
                        app.currentAnnotation.points.push({
                            x: currentX,
                            y: currentY,
                            pressure: pressure,
                            tiltX: tiltX,
                            tiltY: tiltY
                        });
                    }
                } else {
                    app.currentAnnotation.points.push({
                        x: currentX,
                        y: currentY,
                        pressure: pressure,
                        tiltX: tiltX,
                        tiltY: tiltY
                    });
                }
                
                // Update last point
                app.lastPoint = {
                    x: currentX,
                    y: currentY,
                    pressure: pressure
                };
            } else if (app.currentTool === 'eraser') {
                // Continue erasing
                eraseAnnotation(currentX, currentY);
            } else if (app.currentTool === 'rectangle') {
                app.currentAnnotation.width = currentX - app.startX;
                app.currentAnnotation.height = currentY - app.startY;
            } else if (app.currentTool === 'circle') {
                const dx = currentX - app.startX;
                const dy = currentY - app.startY;
                app.currentAnnotation.radius = Math.sqrt(dx * dx + dy * dy);
            } else if (app.currentTool === 'line') {
                app.currentAnnotation.x2 = currentX;
                app.currentAnnotation.y2 = currentY;
            }
            
            // Redraw temporary annotation
            renderTemporaryAnnotation();
        }

        // End annotation
        function endAnnotation(e) {
            if (!app.isDrawing) return;
            
            app.isDrawing = false;
            app.lastPoint = null;
            
            // Check if we need to restore previous tool after stylus button release
            if (app.isStylusButtonPressed && e.pointerType === 'pen') {
                // Check if no buttons are pressed
                if (e.buttons === 0) {
                    app.currentTool = app.previousTool;
                    app.isStylusButtonPressed = false;
                    updateStylusStatus();
                    updateToolButtonSelection();
                }
            }
            
            if (app.currentAnnotation && app.currentTool !== 'eraser') {
                // Add to annotations array
                app.annotations.push(app.currentAnnotation);
                
                // Render the annotation
                const annotationLayer = document.querySelector('.annotation-layer');
                renderAnnotation(app.currentAnnotation, annotationLayer);
                
                // Reset current annotation
                app.currentAnnotation = null;
            }
            
            // Reset stylus indicators
            app.currentPressure = 0;
            app.currentTiltX = 0;
            app.currentTiltY = 0;
            updateStylusIndicators();
        }

        // Update tool button selection
        function updateToolButtonSelection() {
            elements.toolBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tool === app.currentTool) {
                    btn.classList.add('active');
                }
            });
        }

        // Render temporary annotation
        function renderTemporaryAnnotation() {
            const annotationLayer = document.querySelector('.annotation-layer');
            
            // Remove existing temporary annotation
            const tempAnnotation = annotationLayer.querySelector('.temp-annotation');
            if (tempAnnotation) {
                tempAnnotation.remove();
            }
            
            if (!app.currentAnnotation || app.currentTool === 'eraser') return;
            
            // Create temporary annotation element
            const annotationEl = document.createElement('div');
            annotationEl.className = 'annotation temp-annotation';
            annotationEl.style.position = 'absolute';
            
            if (app.currentTool === 'highlight') {
                annotationEl.className += ' highlight-annotation';
                annotationEl.style.left = app.currentAnnotation.x + 'px';
                annotationEl.style.top = app.currentAnnotation.y + 'px';
                annotationEl.style.width = app.currentAnnotation.width + 'px';
                annotationEl.style.height = app.currentAnnotation.height + 'px';
                annotationEl.style.backgroundColor = app.currentAnnotation.color + '80'; // Add transparency
            } else if (app.currentTool === 'pen') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = '0';
                annotationEl.style.top = '0';
                annotationEl.style.width = '100%';
                annotationEl.style.height = '100%';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                // Create multiple path segments for pressure sensitivity
                const segments = createPressureSensitiveSegments(app.currentAnnotation.points);
                
                segments.forEach(segment => {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', segment.d);
                    path.setAttribute('stroke', app.currentAnnotation.color);
                    path.setAttribute('stroke-width', segment.width);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('stroke-linecap', 'round');
                    path.setAttribute('stroke-linejoin', 'round');
                    
                    if (app.stylusSettings.opacityPressure) {
                        path.setAttribute('opacity', segment.opacity);
                    }
                    
                    svg.appendChild(path);
                });
                
                annotationEl.appendChild(svg);
            } else if (app.currentTool === 'rectangle') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = app.currentAnnotation.x + 'px';
                annotationEl.style.top = app.currentAnnotation.y + 'px';
                annotationEl.style.width = app.currentAnnotation.width + 'px';
                annotationEl.style.height = app.currentAnnotation.height + 'px';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', '0');
                rect.setAttribute('y', '0');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('stroke', app.currentAnnotation.color);
                rect.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                rect.setAttribute('fill', 'none');
                
                svg.appendChild(rect);
                annotationEl.appendChild(svg);
            } else if (app.currentTool === 'circle') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = (app.currentAnnotation.x - app.currentAnnotation.radius) + 'px';
                annotationEl.style.top = (app.currentAnnotation.y - app.currentAnnotation.radius) + 'px';
                annotationEl.style.width = (app.currentAnnotation.radius * 2) + 'px';
                annotationEl.style.height = (app.currentAnnotation.radius * 2) + 'px';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '50%');
                circle.setAttribute('cy', '50%');
                circle.setAttribute('r', '50%');
                circle.setAttribute('stroke', app.currentAnnotation.color);
                circle.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                circle.setAttribute('fill', 'none');
                
                svg.appendChild(circle);
                annotationEl.appendChild(svg);
            } else if (app.currentTool === 'line') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = '0';
                annotationEl.style.top = '0';
                annotationEl.style.width = '100%';
                annotationEl.style.height = '100%';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', app.currentAnnotation.x1);
                line.setAttribute('y1', app.currentAnnotation.y1);
                line.setAttribute('x2', app.currentAnnotation.x2);
                line.setAttribute('y2', app.currentAnnotation.y2);
                line.setAttribute('stroke', app.currentAnnotation.color);
                line.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                line.setAttribute('stroke-linecap', 'round');
                
                svg.appendChild(line);
                annotationEl.appendChild(svg);
            }
            
            annotationLayer.appendChild(annotationEl);
        }

        // Create pressure-sensitive segments for drawing
        function createPressureSensitiveSegments(points) {
            const segments = [];
            if (points.length < 2) return segments;
            
            let currentSegment = {
                points: [points[0]],
                avgPressure: points[0].pressure
            };
            
            for (let i = 1; i < points.length; i++) {
                const point = points[i];
                const pressureDiff = Math.abs(point.pressure - currentSegment.avgPressure);
                
                // Start new segment if pressure changes significantly
                if (pressureDiff > 0.1 && currentSegment.points.length > 1) {
                    // Finish current segment
                    const d = createPathData(currentSegment.points);
                    const width = calculateLineWidth(currentSegment.avgPressure);
                    const opacity = app.stylusSettings.opacityPressure ? 
                        0.3 + (currentSegment.avgPressure * 0.7) : 1;
                    
                    segments.push({ d, width, opacity });
                    
                    // Start new segment
                    currentSegment = {
                        points: [points[i-1], point],
                        avgPressure: point.pressure
                    };
                } else {
                    // Add point to current segment
                    currentSegment.points.push(point);
                    currentSegment.avgPressure = (currentSegment.avgPressure * (currentSegment.points.length - 1) + point.pressure) / currentSegment.points.length;
                }
            }
            
            // Add final segment
            if (currentSegment.points.length > 1) {
                const d = createPathData(currentSegment.points);
                const width = calculateLineWidth(currentSegment.avgPressure);
                const opacity = app.stylusSettings.opacityPressure ? 
                    0.3 + (currentSegment.avgPressure * 0.7) : 1;
                
                segments.push({ d, width, opacity });
            }
            
            return segments;
        }

        // Create SVG path data from points
        function createPathData(points) {
            if (points.length < 2) return '';
            
            let d = `M ${points[0].x} ${points[0].y}`;
            
            if (points.length === 2) {
                d += ` L ${points[1].x} ${points[1].y}`;
            } else {
                // Use quadratic curves for smoother lines
                for (let i = 1; i < points.length - 1; i++) {
                    const xc = (points[i].x + points[i + 1].x) / 2;
                    const yc = (points[i].y + points[i + 1].y) / 2;
                    d += ` Q ${points[i].x} ${points[i].y}, ${xc} ${yc}`;
                }
                
                // Add last point
                const last = points[points.length - 1];
                d += ` L ${last.x} ${last.y}`;
            }
            
            return d;
        }

        // Create text annotation
        function createTextAnnotation(x, y) {
            const annotationLayer = document.querySelector('.annotation-layer');
            
            const annotationEl = document.createElement('div');
            annotationEl.className = 'annotation text-annotation';
            annotationEl.style.left = x + 'px';
            annotationEl.style.top = y + 'px';
            annotationEl.style.backgroundColor = app.currentColor + '40'; // Add transparency
            
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Enter your text here...';
            textarea.style.width = '200px';
            textarea.style.height = '80px';
            
            annotationEl.appendChild(textarea);
            annotationLayer.appendChild(annotationEl);
            
            // Focus on textarea
            textarea.focus();
            
            // Save annotation when textarea loses focus
            textarea.addEventListener('blur', () => {
                if (textarea.value.trim() !== '') {
                    const annotation = {
                        type: 'text',
                        x: x,
                        y: y,
                        width: 200,
                        height: 80,
                        text: textarea.value,
                        color: app.currentColor,
                        page: app.pageNum
                    };
                    
                    app.annotations.push(annotation);
                    
                    // Update the annotation element
                    annotationEl.dataset.annotationId = app.annotations.length - 1;
                    annotationEl.style.pointerEvents = 'auto';
                    
                    // Add delete functionality
                    annotationEl.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showAnnotationPopup(e, annotation);
                    });
                } else {
                    annotationEl.remove();
                }
            });
        }

        // Erase annotation at position
        function eraseAnnotation(x, y) {
            const annotationLayer = document.querySelector('.annotation-layer');
            const annotations = annotationLayer.querySelectorAll('.annotation');
            
            for (let i = annotations.length - 1; i >= 0; i--) {
                const ann = annotations[i];
                const rect = ann.getBoundingClientRect();
                const pageRect = annotationLayer.getBoundingClientRect();
                
                const annX = rect.left - pageRect.left;
                const annY = rect.top - pageRect.top;
                const annWidth = rect.width;
                const annHeight = rect.height;
                
                if (x >= annX && x <= annX + annWidth && y >= annY && y <= annY + annHeight) {
                    // Remove from DOM
                    ann.remove();
                    
                    // Remove from annotations array
                    const annotationId = ann.dataset.annotationId;
                    if (annotationId !== undefined) {
                        app.annotations.splice(annotationId, 1);
                    }
                    
                    // Show eraser feedback
                    showToast('Annotation erased', 'info');
                    break;
                }
            }
        }

        // Render annotation
        function renderAnnotation(annotation, container) {
            const annotationEl = document.createElement('div');
            annotationEl.className = 'annotation';
            annotationEl.dataset.annotationId = app.annotations.indexOf(annotation);
            annotationEl.style.position = 'absolute';
            annotationEl.style.pointerEvents = 'auto';
            
            if (annotation.type === 'text') {
                annotationEl.className += ' text-annotation';
                annotationEl.style.left = annotation.x + 'px';
                annotationEl.style.top = annotation.y + 'px';
                annotationEl.style.width = annotation.width + 'px';
                annotationEl.style.height = annotation.height + 'px';
                annotationEl.style.backgroundColor = annotation.color + '40';
                
                const textEl = document.createElement('div');
                textEl.textContent = annotation.text;
                textEl.style.padding = '5px';
                textEl.style.width = '100%';
                textEl.style.height = '100%';
                
                annotationEl.appendChild(textEl);
            } else if (annotation.type === 'highlight') {
                annotationEl.className += ' highlight-annotation';
                annotationEl.style.left = annotation.x + 'px';
                annotationEl.style.top = annotation.y + 'px';
                annotationEl.style.width = annotation.width + 'px';
                annotationEl.style.height = annotation.height + 'px';
                annotationEl.style.backgroundColor = annotation.color + '80';
            } else if (annotation.type === 'draw') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = '0';
                annotationEl.style.top = '0';
                annotationEl.style.width = '100%';
                annotationEl.style.height = '100%';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                // Create pressure-sensitive segments
                const segments = createPressureSensitiveSegments(annotation.points);
                
                segments.forEach(segment => {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', segment.d);
                    path.setAttribute('stroke', annotation.color);
                    path.setAttribute('stroke-width', segment.width);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('stroke-linecap', 'round');
                    path.setAttribute('stroke-linejoin', 'round');
                    
                    if (app.stylusSettings.opacityPressure) {
                        path.setAttribute('opacity', segment.opacity);
                    }
                    
                    svg.appendChild(path);
                });
                
                annotationEl.appendChild(svg);
            } else if (annotation.type === 'rectangle') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = annotation.x + 'px';
                annotationEl.style.top = annotation.y + 'px';
                annotationEl.style.width = annotation.width + 'px';
                annotationEl.style.height = annotation.height + 'px';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', '0');
                rect.setAttribute('y', '0');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('stroke', annotation.color);
                rect.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                rect.setAttribute('fill', 'none');
                
                svg.appendChild(rect);
                annotationEl.appendChild(svg);
            } else if (annotation.type === 'circle') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = (annotation.x - annotation.radius) + 'px';
                annotationEl.style.top = (annotation.y - annotation.radius) + 'px';
                annotationEl.style.width = (annotation.radius * 2) + 'px';
                annotationEl.style.height = (annotation.radius * 2) + 'px';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '50%');
                circle.setAttribute('cy', '50%');
                circle.setAttribute('r', '50%');
                circle.setAttribute('stroke', annotation.color);
                circle.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                circle.setAttribute('fill', 'none');
                
                svg.appendChild(circle);
                annotationEl.appendChild(svg);
            } else if (annotation.type === 'line') {
                annotationEl.className += ' drawing-annotation';
                annotationEl.style.left = '0';
                annotationEl.style.top = '0';
                annotationEl.style.width = '100%';
                annotationEl.style.height = '100%';
                
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.style.width = '100%';
                svg.style.height = '100%';
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', annotation.x1);
                line.setAttribute('y1', annotation.y1);
                line.setAttribute('x2', annotation.x2);
                line.setAttribute('y2', annotation.y2);
                line.setAttribute('stroke', annotation.color);
                line.setAttribute('stroke-width', app.stylusSettings.maxLineWidth);
                line.setAttribute('stroke-linecap', 'round');
                
                svg.appendChild(line);
                annotationEl.appendChild(svg);
            }
            
            // Add delete functionality
            annotationEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showAnnotationPopup(e, annotation);
            });
            
            container.appendChild(annotationEl);
        }

        // Render annotations for a specific page
        function renderAnnotationsForPage(pageNum, container) {
            const pageAnnotations = app.annotations.filter(ann => ann.page === pageNum);
            pageAnnotations.forEach(annotation => {
                renderAnnotation(annotation, container);
            });
        }

        // Show annotation popup
        function showAnnotationPopup(e, annotation) {
            app.selectedAnnotation = annotation;
            elements.annotationPopup.style.left = e.pageX + 'px';
            elements.annotationPopup.style.top = e.pageY + 'px';
            elements.annotationPopup.style.display = 'block';
        }

        // Delete selected annotation
        function deleteSelectedAnnotation() {
            if (!app.selectedAnnotation) return;
            
            const index = app.annotations.indexOf(app.selectedAnnotation);
            if (index !== -1) {
                app.annotations.splice(index, 1);
                
                // Re-render the page
                renderPage(app.pageNum);
                
                showToast('Annotation deleted');
            }
            
            elements.annotationPopup.style.display = 'none';
        }

        // Clear all annotations
        function clearAllAnnotations() {
            if (app.annotations.length === 0) {
                showToast('No annotations to clear', 'info');
                return;
            }
            
            if (confirm('Are you sure you want to clear all annotations?')) {
                app.annotations = [];
                renderPage(app.pageNum);
                showToast('All annotations cleared');
            }
        }

        // Save annotated PDF (simplified for demo)
        function saveAnnotatedPDF() {
            showToast('Annotated PDF saved successfully!');
        }

        // Calibrate stylus
        function calibrateStylus() {
            showToast('Stylus calibration started. Please draw on the screen.');
            
            // In a real implementation, this would involve:
            // 1. Creating a calibration screen
            // 2. Asking the user to draw specific patterns
            // 3. Analyzing the input to adjust pressure and tilt sensitivity
            // 4. Saving the calibration settings
            
            // For this demo, we'll just show a success message after a delay
            setTimeout(() => {
                showToast('Stylus calibration completed successfully!');
            }, 2000);
        }

        // Update stylus indicators
        function updateStylusIndicators() {
            // Update pressure bar
            const pressurePercent = app.currentPressure * 100;
            elements.pressureBar.style.width = pressurePercent + '%';
            
            // Update tilt values
            elements.tiltX.textContent = Math.round(app.currentTiltX);
            elements.tiltY.textContent = Math.round(app.currentTiltY);
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            elements.toastMessage.textContent = message;
            
            // Set toast color based on type
            if (type === 'error') {
                elements.toast.style.backgroundColor = '#e74c3c';
                elements.toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'info') {
                elements.toast.style.backgroundColor = '#3498db';
                elements.toast.querySelector('i').className = 'fas fa-info-circle';
            } else {
                elements.toast.style.backgroundColor = '#2ecc71';
                elements.toast.querySelector('i').className = 'fas fa-check-circle';
            }
            
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Initialize the application
        function init() {
            initEventListeners();
            initInkPreview();
            updateZoomLevel();
            updateStylusStatus();
            
            // Check for stylus support
            if (window.PointerEvent) {
                showToast('Stylus support detected! Your device is ready for precise annotations.');
            } else {
                showToast('Stylus support not available. Using touch/mouse input instead.', 'info');
            }
        }

        // Start the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
